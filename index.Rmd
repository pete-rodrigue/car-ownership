---
title: "Car ownership in DC"
author: "pete rodrigue"
date: "2026-02-18"
output: html_document
---

```{r setup, include=F, echo=F, warning=F, message=F}
knitr::opts_chunk$set(echo=F, warning=F, message=F)
library(readr)
library(sf)
library(dplyr)
library(leaflet)
library(rstudioapi)
library(ggplot2)
# devtools::install_github("liamgilbey/ggwaffle")
library(ggwaffle)
library(patchwork)
library(tigris)

# set working directory to be the folder that this Rmd file is saved in, 
# for convenience 
current_path = rstudioapi::getActiveDocumentContext()$path 
setwd(dirname(current_path))
# print(getwd())

# load car ownership data
co <- readr::read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSOGUHkvJwIW_vFfjCPjvBQBW2K9JAfl7An78DTK5CLW-LIrFRBxBMgexXweqZbgLpOUMZXxwbwyF30/pub?gid=1380852961&single=true&output=csv") %>%
  sf::st_as_sf(., coords = c("Geocodio Longitude", "Geocodio Latitude"), crs = 4326)

# https://opendata.dc.gov/datasets/DCGIS::single-member-district-from-2023/about
smd <- sf::st_read("data/Single_Member_District_from_2023/Single_Member_District_from_2023.shp") %>%
  sf::st_transform(crs = 4326)

# https://opendata.dc.gov/datasets/DCGIS::advisory-neighborhood-commissions-from-2023/about
anc <- sf::st_read("data/Advisory_Neighborhood_Commissions_from_2023/Advisory_Neighborhood_Commissions_from_2023.shp") %>%
  sf::st_transform(crs = 4326)

# https://opendata.dc.gov/datasets/DCGIS::address-points/about
pts <- readr::read_csv("data/Address_Points.csv") %>%
  sf::st_as_sf(., coords = c("LONGITUDE", "LATITUDE"), crs = 4326)

# https://opendata.dc.gov/datasets/a53c0f02804a484b87027ce3ef3ff38b_41/about
trt_d <- sf::st_read("data/ACS_5-Year_Economic_Characteristics_DC_Census_Tract/ACS_5-Year_Economic_Characteristics_DC_Census_Tract.shp") %>%
  select(TRACTCE, DP03_0062E) %>%
  rename(
         med_hh_inc = DP03_0062E,
         TRACT = TRACTCE
         ) %>%
  sf::st_transform(crs = 4326)

# https://opendata.dc.gov/datasets/DCGIS::census-tracts-in-2020/about
trt <- sf::st_read("data/Census_Tracts_in_2020/Census_Tracts_in_2020.shp") %>%
  select(TRACT, H0010001, P0030001) %>%
  rename(
         num_hh = H0010001, 
         pop_over_18 = P0030001
         ) %>%
  sf::st_transform(crs = 4326)

# https://opendata.dc.gov/datasets/DCGIS::metro-stations-regional/about
mto <- 
  sf::st_read("data/Metro_Stations_(Regional)/Metro_Stations_(Regional).shp") %>%
  mutate(state = substr(ADDRESS, nchar(ADDRESS) - 2 + 1, nchar(ADDRESS))) %>%
  filter(state == "DC")
```


In January 2016, there were `r format(sum(co[["Count of Vehicles"]]), big.mark = ",")` vehicles registered with the DC DMV at `r format(length(unique(co$Address)), big.mark=",")` residential addresses, according to data provided in a recent FOIA request.

Keep in mind that this does not include any vehicles that residents are using that they have not registered with the DC DMV. This also doesn't include non-residential vehicles.

The DC DMV website says there are [310,000](https://dmv.dc.gov/page/about-dc-dmv) total vehicles registered in DC.

If we just add up the number of 9'x18' parking spaces required for all these 310,000 vehicles, we get a total area of 1.8 square miles (162 sqft * 310,000 vehicles * 3.58701e-8 sqmi/sqft). If you parked all of these cars bumper to bumper, they would cover Capitol Hill.

```{r}
# Capitol Hill neighborhood center (approximate)
center_lat <- 38.8897
center_lon <- -76.9975

# 1.8 square miles = 1.8 * 2589988.11 square meters
target_area_m2 <- 1.8 * 2589988.11

# Calculate side length of a square with that area (in meters)
side_m <- sqrt(target_area_m2)

# Convert side length to degrees
# 1 degree latitude ~ 111,320 meters
# 1 degree longitude ~ 111,320 * cos(lat) meters
lat_deg <- side_m / 111320
lon_deg <- side_m / (111320 * cos(center_lat * pi / 180))

# Build the polygon corners
half_lat <- lat_deg / 2
half_lon <- lon_deg / 2

polygon_coords <- matrix(
  c(
    center_lon - half_lon, center_lat - half_lat,
    center_lon + half_lon, center_lat - half_lat,
    center_lon + half_lon, center_lat + half_lat,
    center_lon - half_lon, center_lat + half_lat,
    center_lon - half_lon, center_lat - half_lat  # close the polygon
  ),
  ncol = 2, byrow = TRUE
)

# Create an sf polygon
capitol_hill_poly <- st_sfc(
  st_polygon(list(polygon_coords)),
  crs = 4326
)

# Verify area (should be close to 1.8 sq miles)
area_m2 <- as.numeric(st_area(st_transform(capitol_hill_poly, 32618)))
area_sq_miles <- area_m2 / 2589988.11
# cat(sprintf("Polygon area: %.4f square miles\n", area_sq_miles))

# Draw the map
leaflet() |>
  addProviderTiles(providers$CartoDB.Positron) |>
  addPolygons(
    data       = capitol_hill_poly,
    color      = "#B22222",
    weight     = 2,
    opacity    = 1,
    fillColor  = "#B22222",
    fillOpacity = 0.2,
    label      = "Capitol Hill (~1.8 sq mi)"
  ) |>
  setView(lng = center_lon, lat = center_lat, zoom = 12)
```

Here is the breakdown of how many households owned one, versus, two, versus 3 vehicles, etc:

```{r}
# table(co$`Count of Vehicles`)
```

And here is that same breakdown in percentage terms:

```{r}
# round(prop.table(table(co$`Count of Vehicles`))*100, 5)
```


```{r}
pcts <- prop.table(table(co$`Count of Vehicles`))*100

car_stats <- as.numeric(names(pcts)) * pcts

w_pcts <- car_stats / sum(car_stats) * 100
w_pcts_trunc <- round(c(w_pcts[1:3], "4" = sum(w_pcts[4:length(w_pcts)])))
pcts_trunc <- round(c(pcts[1:3], "4" = sum(pcts[4:length(pcts)])))





df1 <-
  data.frame(
    c(rep(1, pcts_trunc["1"]),
      rep(2, pcts_trunc["2"]),
      rep(3, pcts_trunc["3"]),
      rep(4, pcts_trunc["4"])
      )
  )
names(df1) <- "cc"
df1$ones <- 1
df1$cc <- as.factor(df1$cc)
# due to rounding we have one to many boxes (101), so remove the last box, since
# the 4+ group was farthest from being rounded up (even though it was)
df1 <- df1[1:100,]  


df2 <-
  data.frame(
    c(rep(1, w_pcts_trunc["1"]),
      rep(2, w_pcts_trunc["2"]),
      rep(3, w_pcts_trunc["3"]),
      rep(4, w_pcts_trunc["4"])
      )
  )
names(df2) <- "cc"
df2$ones <- 1
df2$cc <- as.factor(df2$cc)


waffle_data <- waffle_iron(df1, aes_d(group = cc), rows = 4)

p1 <-
  ggplot(waffle_data, aes(x, y, fill = group)) + 
  geom_waffle() + 
  coord_equal() + 
  scale_fill_manual(
                    name = "# cars reg. at address",
                    values = c("#ABEDC4", "#35D472", "#19763D", "#072211"),
                    labels = c("1", "2", "3", "4+")
                      ) +
  theme_waffle() +
  theme(legend.position = "none") +
  xlab("") +
  ylab("") +
  ggtitle("For example, only about 1.6% of households own 4 or more cars...") +
  theme(plot.title = element_text(size = 12))


waffle_data <- waffle_iron(df2, aes_d(group = cc), rows = 4)

p2 <-
  ggplot(waffle_data, aes(x, y, fill = group)) + 
  geom_waffle() + 
  coord_equal() + 
  scale_fill_manual(
                    name = "# cars registered at address",
                    values = c("#ABEDC4", "#35D472", "#19763D", "#072211"),
                    labels = c("1", "2", "3", "4+")
                      ) +
  theme_waffle() +
  theme(legend.position = "bottom") +
  xlab("") +
  ylab("") +
  ggtitle("But those households account for almost 6% of cars registered in DC") +
  theme(plot.title = element_text(size = 12))


p1 / p2 + 
  plot_annotation('Households with multiple cars are disproportionate share of total car ownership in DC', 
                  caption = paste0(
                    "There are 100 squares in each plot.\n", 
                    "In the first plot, each square represents roughly 900 addresses/households. (There are 89,871 total addresses in the data set).\n",
                    "In the second plot, each square represents roughly 1,200 vehicles. (There are 118,907 total vehicles in the data set)."),
                          theme=theme(plot.title=element_text(hjust=0.5),
                                      plot.caption = element_text(hjust = 0))
                  )

```

According to this FOIA'd data, here is the number of cars registered in each ANC Single Member District (SMD):

```{r}
smd_co <- 
  sf::st_join(x = smd, y = co) %>%
  sf::st_drop_geometry() %>%
  group_by(SMD_ID) %>%
  summarize(nv = sum(`Count of Vehicles`, na.rm=T))

smd_co <- dplyr::left_join(smd %>% select(SMD_ID), smd_co, by="SMD_ID")


pal <- colorNumeric(
  palette = "YlOrRd", 
  domain = smd_co$nv
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
  data = smd_co, 
  fillColor = ~pal(nv),      # Fill color of the polygons
  color = "grey",          # Border color
  weight = 1,              # Border thickness
  fillOpacity = 0.6,       # Fill opacity
  label = ~paste0("SMD ", SMD_ID, ": ", `nv`)            # Add interactive popups (e.g., county name)
  )

```



Here is the number of vehicles registered as a percentage of the number of households in the tract in 2020.

```{r}
trt_co <- 
  sf::st_join(x = trt %>% sf::st_transform(4326), y = co) %>%
  sf::st_drop_geometry() %>%
  group_by(TRACT) %>%
  summarize(
            nv = sum(`Count of Vehicles`, na.rm=T),
            num_hh = max(num_hh, na.rm=T), 
            pop_over_18 = max(pop_over_18, na.rm=T)
            ) %>%
  mutate(
          nv_hh = round(nv / num_hh*100),
          nv_po = round(nv / pop_over_18*100)
          ) %>%
  mutate(
    nv_hh = ifelse(nv_hh > 100, 100, nv_hh),
    nv_po = ifelse(nv_po > 100, 100, nv_po)
  )

trt_co <- dplyr::left_join(trt %>% select(TRACT), trt_co, by="TRACT")

pal <- colorNumeric(
  palette = "YlOrRd", 
  domain = trt_co$nv_hh
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
  data = trt_co %>% sf::st_transform(4326), 
  fillColor = ~pal(nv_hh),      # Fill color of the polygons
  color = "grey",          # Border color
  weight = 1,              # Border thickness
  fillOpacity = 0.6,       # Fill opacity
  label = ~paste0("Tract ", TRACT, ": ", nv_hh, "% of 2020 HH")            # Add interactive popups (e.g., county name)
  )

```


We can also correlate median household income in each tract in the 2019-2023 5-year American Community Survey with our "# vehicles / # households" statistic. When we do this, we find that every $25,000 increase in tract median income is associated with an increase of 7 additional cars per household.


```{r}
trt_d_co <- 
  sf::st_join(x = trt_d %>% sf::st_transform(4326), y = co) %>%
  sf::st_drop_geometry() %>%
  group_by(TRACT) %>%
  summarize(
            nv = sum(`Count of Vehicles`, na.rm=T),
            med_hh_inc = max(med_hh_inc, na.rm=T)
            ) %>%
  dplyr::left_join(y = trt %>% sf::st_drop_geometry(), by = "TRACT") %>%
    mutate(
          nv_hh = round(nv / num_hh*100),
          nv_po = round(nv / pop_over_18*100)
          ) %>%
  mutate(
    nv_hh = ifelse(nv_hh > 100, 100, nv_hh),
    nv_po = ifelse(nv_po > 100, 100, nv_po)
  ) %>% 
  filter(med_hh_inc != -Inf)


# GET EQUATION AND R-SQUARED AS STRING
# SOURCE: https://groups.google.com/forum/#!topic/ggplot2/1TgH-kG5XMA

lm_eqn <- function(df, x, y){
    m <- lm( formula(paste(y, " ~ ", x)), df);
    eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}

ggplot(data = trt_d_co,
       aes(x = med_hh_inc, y = nv_hh)) +
  geom_point() +
  geom_smooth(method = "lm") +
  geom_text(x = 50000, y = 80, label = lm_eqn(trt_d_co, x = "med_hh_inc", "nv_hh"), parse = TRUE) +
  ylab("# vehicles / # households") +
  xlab("Median household income") +
  theme_minimal() +
  ggtitle("Richer areas have more cars") +
  labs(caption = "Note: tract income is top-coded at $250,000") +
  theme(plot.caption = element_text(hjust = 0))
```


```{r}
mto_buffer <- sf::st_buffer(x = mto, dist = 800) %>% sf::st_transform(4326)
n_cars_by_metro <-
  sf::st_join(x = sf::st_as_sf(sf::st_union(mto_buffer, by_feature = F)), y = co) %>%
  sf::st_drop_geometry() %>%
  # group_by(NAME) %>%
  summarize(nv = sum(`Count of Vehicles`, na.rm=T)) %>%
  pull(nv)
```

There are `r format(n_cars_by_metro, big.mark=",")` registered cars within 800 meters of a metro station in DC according to this data set. That is `r round(n_cars_by_metro / sum(co[["Count of Vehicles"]]) * 100)`% of the total number of vehicles.

```{r}
leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
  data = sf::st_union(mto_buffer, by_feature = F), 
  fillColor = "blue",      # Fill color of the polygons
  color = "grey",          # Border color
  weight = 1,              # Border thickness
  fillOpacity = 0.6        # Fill opacity
  )
```






